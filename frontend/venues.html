<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venue Booking</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        /* Page layout: single-screen, non-scrolling (content fits into viewport) */
        :root{--panel-width:420px}

        .page-wrap{display:flex;gap:20px;height:calc(100vh - var(--nav-height));padding:18px;box-sizing:border-box}

        /* Left: filter + grid */
        .left-col{flex:1;display:flex;flex-direction:column;gap:12px;overflow:hidden}

        /* Sticky filter bar */
        .filter-bar{position:sticky;top:var(--nav-height);background:rgba(255,255,255,0.95);padding:12px;border-radius:8px;box-shadow:var(--shadow);display:flex;gap:10px;align-items:center;z-index:50}
        .filter-bar .control{min-width:0;flex:1}

        /* Grid that fills remaining space without causing page scroll */
        .grid-wrap{flex:1;overflow:auto;padding:6px}
        .venue-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}

        .venue-card{background:var(--card-bg);border-radius:10px;padding:14px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:8px;transition:transform var(--transition),box-shadow var(--transition);}
        .venue-card:hover{transform:translateY(-6px);box-shadow:0 14px 30px rgba(0,0,0,0.12)}

        .venue-title{font-weight:700;font-size:16px}
        .meta-row{font-size:13px;color:#667;display:flex;justify-content:space-between;gap:8px}
        .equip{font-size:13px;color:#445;opacity:0.9}

        .badge-available{background:var(--success);color:#fff;padding:6px 8px;border-radius:8px;font-weight:700}
        .badge-partial{background:var(--warning);color:#111;padding:6px 8px;border-radius:8px;font-weight:700}
        .badge-booked{background:var(--danger);color:#fff;padding:6px 8px;border-radius:8px;font-weight:700}

        .card-actions{display:flex;gap:8px;margin-top:auto}

        /* Right: booking panel */
        .right-col{width:var(--panel-width);display:flex;flex-direction:column;gap:12px}
        .booking-panel{background:var(--card-bg);padding:16px;border-radius:10px;box-shadow:var(--shadow);transform:translateX(16px);transition:transform var(--transition),opacity var(--transition);opacity:0;pointer-events:none}
        .booking-panel.open{transform:translateX(0);opacity:1;pointer-events:auto}

        .bookings-collapsed{background:var(--card-bg);padding:12px;border-radius:10px;box-shadow:var(--shadow)}
        .toggle-btn{background:transparent;border:1px solid #ddd;padding:8px 12px;border-radius:8px;cursor:pointer}

        .notice{padding:8px 10px;border-radius:8px;background:#fff3cd;color:#856404;font-size:14px}

        /* Ensure small screens degrade gracefully */
        @media (max-width:980px){.page-wrap{flex-direction:column;height:calc(100vh - var(--nav-height));padding:12px}.right-col{width:100%}.booking-panel{position:relative}}
    </style>
</head>
<body>
    <div id="navbar"></div>

<script>
    fetch("/css/components/navbar.html")
        .then(res => res.text())
        .then(html => {
            document.getElementById("navbar").innerHTML = html;
            const logoutBtn = document.getElementById("logoutBtn");
            if (logoutBtn) logoutBtn.addEventListener("click", () => { localStorage.clear(); window.location.href = "/"; });
        });
</script>

    <div class="nav-spacer"></div>

    <div class="page-wrap">
        <div class="left-col">
            <div class="filter-bar" role="region" aria-label="Venue filters">
                <select id="areaFilter" class="control">
                    <option value="">All areas</option>
                    <option value="Main Block">Main Block</option>
                    <option value="PG Block">PG Block</option>
                    <option value="KE Block">KE Block</option>
                    <option value="Outdoor Areas">Outdoor Areas</option>
                </select>

                <input type="date" id="filterFrom" class="control" aria-label="From date">
                <input type="date" id="filterTo" class="control" aria-label="To date">
                <input type="number" id="minCapacity" class="control" placeholder="Min capacity" min="0" aria-label="Minimum capacity">
            </div>

            <div class="grid-wrap">
                <div id="venueGrid" class="venue-grid" aria-live="polite"></div>
            </div>
        </div>

        <div class="right-col">
            <div class="booking-panel" id="bookingPanel" aria-hidden="true">
                <h3 id="panelTitle">Book Venue</h3>
                <form id="panelForm">
                    <label>Area</label>
                    <input type="text" id="panelArea" readonly>
                    <label>Venue</label>
                    <input type="text" id="panelVenue" readonly>
                    <label>Event name</label>
                    <input type="text" id="panelEvent" required>
                    <label>Club name</label>
                    <input type="text" id="panelClub" required>
                    <label>From</label>
                    <input type="date" id="panelFrom" required>
                    <label>To</label>
                    <input type="date" id="panelTo" required>

                    <div id="panelNotice" class="notice" style="display:none"></div>

                    <div style="display:flex;gap:8px;margin-top:10px">
                        <button type="submit" id="panelSubmit">Book</button>
                        <button type="button" id="panelClose" class="toggle-btn">Close</button>
                    </div>
                </form>
            </div>

            <div class="bookings-collapsed">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <strong>My Bookings</strong>
                    <button id="toggleBookings" class="toggle-btn">Show</button>
                </div>
                <div id="bookingsWrap" style="margin-top:10px;display:none;max-height:40vh;overflow:auto">
                    <table id="venueTable" style="width:100%">
                        <tr><th>Event</th><th>Club</th><th>From</th><th>To</th><th>Venue</th><th>Status</th><th>Actions</th></tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // -- AUTH CHECK (redirect if no role) --
        const role = localStorage.getItem("role");
        if (!role) {
            // silently redirect to login
            window.location.href = "/";
        }

        // -- DATA: venues (derived from original table content) --
        const venuesData = [
            {name:"Sunya Lab", location:"Main Block", equipment:"3D printer, Laser cutter, Vinyl cutter", capacity:20},
            {name:"Multimedia hall", location:"Main Block", equipment:"Projector, Speakers, Mic system", capacity:100},
            {name:"Heisenberg Lab", location:"Main Block", equipment:"Computing equipment, IoT equipment", capacity:77},
            {name:"Quantum Lab", location:"Main Block", equipment:"Computing equipment, Projector", capacity:75},
            {name:"Zuse Lab", location:"Main Block", equipment:"Computing equipment, Networking components", capacity:76},
            {name:"Ulysses Lab", location:"Main Block", equipment:"Computing equipment", capacity:35},
            {name:"CCF Lab", location:"Main Block", equipment:"Computing equipment", capacity:75},
            {name:"Gallery Hall", location:"PG Block", equipment:"Projector, Mic system, Speakers", capacity:300},
            {name:"Project Laboratory", location:"KE Block", equipment:"Welding machine, Hacksaw, Grinding machine", capacity:50},
            {name:"Language Lab", location:"KE Block", equipment:"Computing equipment, Headphones", capacity:75},
            {name:"Sycamore lab Phase 1", location:"KE Block", equipment:"Computing equipment", capacity:75},
            {name:"Sycamore lab Phase 2", location:"KE Block", equipment:"Computing equipment", capacity:75},
            {name:"CU Seminar Hall", location:"KE Block", equipment:"Projector", capacity:72},
            {name:"Conference Hall", location:"KE Block", equipment:"Projector, Mic system, Speakers", capacity:250},
            {name:"Auditorium", location:"KE Block", equipment:"Projector, Mic and speaker system, Displays, Lighting system", capacity:2500},
            {name:"Badminton Court", location:"KE Block", equipment:"Floodlight", capacity:0},
            {name:"Table tennis Court", location:"KE Block", equipment:"Floodlight", capacity:0},
            {name:"Basketball Court", location:"Outdoor Areas", equipment:"Floodlight, Open ground", capacity:300},
            {name:"Volleyball Court", location:"Outdoor Areas", equipment:"Floodlight, Open ground", capacity:0},
            {name:"Football Ground", location:"Outdoor Areas", equipment:"Open ground", capacity:0},
            {name:"Cricket Ground", location:"Outdoor Areas", equipment:"Floodlight, Open ground, Pavilion", capacity:0},
            {name:"Cricket Nets", location:"Outdoor Areas", equipment:"Nets", capacity:0},
            {name:"Parking Gound", location:"Outdoor Areas", equipment:"Open ground", capacity:0},
            {name:"Chavara Hall", location:"Outdoor Areas", equipment:"Lighting system, Mic and speaker system, Displays", capacity:600},
            {name:"STEAG", location:"Outdoor Areas", equipment:"Open space", capacity:0},
            {name:"The Bamboos", location:"Outdoor Areas", equipment:"Open space", capacity:20}
        ];

        // Store bookings loaded from server
        let currentBookings = [];
        let bookedDatesByVenue = {}; // map venue -> Set(dates)

        // Fetch bookings and build quick lookup
        async function loadBookings() {
            const res = await fetch('/venue-bookings');
            currentBookings = await res.json();

            bookedDatesByVenue = {};
            currentBookings.forEach(b => {
                if (!bookedDatesByVenue[b.venue]) bookedDatesByVenue[b.venue] = new Set();
                let from = new Date(b.from_date);
                const to = new Date(b.to_date);
                for (let d = new Date(from); d <= to; d.setDate(d.getDate()+1)) {
                    bookedDatesByVenue[b.venue].add(new Date(d).toISOString().split('T')[0]);
                }
            });
        }

        // Compute availability status for a venue given optional filter range
        function computeAvailability(venueName, filterFrom, filterTo) {
            const booked = bookedDatesByVenue[venueName] || new Set();
            if (!filterFrom || !filterTo) {
                // No filter -> if any booked dates exist -> partially/booked else available
                if (booked.size === 0) return 'Available';
                return 'Partially Booked';
            }
            // Check if all days in range are booked
            let from = new Date(filterFrom);
            let to = new Date(filterTo);
            let totalDays = 0, bookedDays = 0;
            for (let d = new Date(from); d <= to; d.setDate(d.getDate()+1)) {
                totalDays++;
                if (booked.has(d.toISOString().split('T')[0])) bookedDays++;
            }
            if (bookedDays === 0) return 'Available';
            if (bookedDays === totalDays) return 'Booked';
            return 'Partially Booked';
        }

        // Render cards according to filters
        function renderCards() {
            const area = document.getElementById('areaFilter').value;
            const from = document.getElementById('filterFrom').value;
            const to = document.getElementById('filterTo').value;
            const minCap = parseInt(document.getElementById('minCapacity').value || '0', 10);
            const container = document.getElementById('venueGrid');
            container.innerHTML = '';

            const filtered = venuesData.filter(v => {
                if (area && v.location !== area) return false;
                if (v.capacity < minCap) return false;
                return true;
            });

            filtered.forEach(v => {
                const avail = computeAvailability(v.name, from, to);
                const card = document.createElement('div');
                card.className = 'venue-card';
                card.innerHTML = `
                    <div class="venue-title">${v.name}</div>
                    <div class="meta-row"><span>${v.location}</span><span>${v.capacity>0? v.capacity+' seats':'—'}</span></div>
                    <div class="equip">${v.equipment.length>80? v.equipment.slice(0,80)+'…':v.equipment}</div>
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div class="badge ${avail==='Available'?'badge-available':avail==='Partially Booked'?'badge-partial':'badge-booked'}">${avail}</div>
                        <div class="card-actions">
                            <button class="toggle-btn" data-venue="${encodeURIComponent(v.name)}" data-area="${encodeURIComponent(v.location)}">Details</button>
                            <button class="btn" data-book="${encodeURIComponent(v.name)}">Book</button>
                        </div>
                    </div>
                `;

                // actions
                card.querySelector('[data-book]')?.addEventListener('click', () => openBookingPanel(v, from, to));
                card.querySelector('[data-venue]')?.addEventListener('click', () => showDetails(v));

                container.appendChild(card);
            });
        }

        function showDetails(v) {
            // simple inline details modal replacement — use accessibility-friendly dialog in future
            const msg = `${v.name} — ${v.location}\nEquipment: ${v.equipment}\nCapacity: ${v.capacity>0? v.capacity:'N/A'}`;
            // Use non-blocking notification
            showPanelMessage(msg, 3500);
        }

        // Booking panel controls
        const bookingPanel = document.getElementById('bookingPanel');
        const panelForm = document.getElementById('panelForm');
        const panelNotice = document.getElementById('panelNotice');

        function openBookingPanel(venueObj, filterFrom, filterTo) {
            document.getElementById('panelArea').value = venueObj.location;
            document.getElementById('panelVenue').value = venueObj.name;
            document.getElementById('panelEvent').value = '';
            document.getElementById('panelClub').value = '';
            document.getElementById('panelFrom').value = filterFrom || '';
            document.getElementById('panelTo').value = filterTo || '';
            panelNotice.style.display = 'none';
            bookingPanel.classList.add('open');
            bookingPanel.setAttribute('aria-hidden','false');
        }

        document.getElementById('panelClose').addEventListener('click', () => {
            bookingPanel.classList.remove('open');
            bookingPanel.setAttribute('aria-hidden','true');
        });

        // Toggle bookings list
        document.getElementById('toggleBookings').addEventListener('click', () => {
            const wrap = document.getElementById('bookingsWrap');
            const btn = document.getElementById('toggleBookings');
            if (wrap.style.display === 'none' || wrap.style.display === '') {
                wrap.style.display = 'block'; btn.textContent = 'Hide';
            } else { wrap.style.display = 'none'; btn.textContent = 'Show'; }
        });

        // Inline non-blocking message area (top-right small toast)
        function showPanelMessage(text, timeout=2000) {
            panelNotice.textContent = text; panelNotice.style.display = 'block';
            if (timeout) setTimeout(()=> panelNotice.style.display='none', timeout);
        }

        // Submit booking from panel (uses same endpoints as before)
        panelForm.addEventListener('submit', async function(e){
            e.preventDefault();
            const eventName = document.getElementById('panelEvent').value.trim();
            const clubName = document.getElementById('panelClub').value.trim();
            const fromDate = document.getElementById('panelFrom').value;
            const toDate = document.getElementById('panelTo').value;
            const venue = document.getElementById('panelVenue').value;

            if (!venue) return showPanelMessage('Select a venue.');

            // client-side availability check (non-alert)
            await loadBookings(); // refresh bookings
            const overlapping = currentBookings.some(b => b.venue === venue && (
                (fromDate >= b.from_date && fromDate <= b.to_date) ||
                (toDate >= b.from_date && toDate <= b.to_date) ||
                (fromDate <= b.from_date && toDate >= b.to_date)
            ));

            if (overlapping) {
                panelNotice.style.display = 'block';
                panelNotice.textContent = 'Selected range overlaps existing booking. Pick different dates.';
                return;
            }

            // send booking
            await fetch('/book-venue', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ event_name: eventName, club_name: clubName, from_date: fromDate, to_date: toDate, venue })
            });

            showPanelMessage('Booked successfully!', 2000);
            bookingPanel.classList.remove('open');
            await refreshAll();
        });

        // Delete booking (replaces confirm() with inline show)
        async function deleteBooking(id) {
            if (!confirm) { // still use native confirm for destructive action — keep minimal
                // fallback
            }
            // Simple UI confirm via window.confirm (kept minimal); could be replaced with modal
            if (!window.confirm('Delete booking?')) return;
            await fetch(`/delete-booking/${id}`, {method:'DELETE'});
            await refreshAll();
        }

        // Populate bookings table
        async function renderBookingsTable() {
            const table = document.getElementById('venueTable');
            table.innerHTML = '<tr><th>Event</th><th>Club</th><th>From</th><th>To</th><th>Venue</th><th>Status</th><th>Actions</th></tr>';
            currentBookings.forEach(b => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${escapeHtml(b.event_name)}</td><td>${escapeHtml(b.club_name)}</td><td>${b.from_date}</td><td>${b.to_date}</td><td>${escapeHtml(b.venue)}</td><td>${escapeHtml(b.status)}</td><td><button class="toggle-btn" onclick="editBooking(${b.id}, '${escapeJs(b.event_name)}', '${escapeJs(b.club_name)}', '${escapeJs(b.venue)}', '${b.from_date}', '${b.to_date}')">Edit</button> <button class="toggle-btn" onclick="deleteBooking(${b.id})">Delete</button></td>`;
                table.appendChild(tr);
            });
        }

        // provide global editBooking (used by table buttons)
        window.editBooking = function(id, eventName, clubName, venue, fromDate, toDate) {
            document.getElementById('panelArea').value = ''; // unknown
            document.getElementById('panelVenue').value = venue;
            document.getElementById('panelEvent').value = eventName;
            document.getElementById('panelClub').value = clubName;
            document.getElementById('panelFrom').value = fromDate;
            document.getElementById('panelTo').value = toDate;
            bookingPanel.classList.add('open');
            // change submission to update instead of create
            panelForm.onsubmit = async function(e){
                e.preventDefault();
                await fetch(`/edit-booking/${id}`, {method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({ event_name: document.getElementById('panelEvent').value, club_name: document.getElementById('panelClub').value, from_date: document.getElementById('panelFrom').value, to_date: document.getElementById('panelTo').value, venue: document.getElementById('panelVenue').value })});
                showPanelMessage('Booking updated',1500); bookingPanel.classList.remove('open'); await refreshAll();
                panelForm.onsubmit = defaultPanelSubmit;
            };
        };

        // helpers
        function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
        function escapeJs(s){ return (s||'').replace(/'/g,"\\'").replace(/"/g,'\"'); }

        // default panel submit (re-usable)
        async function defaultPanelSubmit(e) { e.preventDefault(); }
        window.defaultPanelSubmit = defaultPanelSubmit;

        // Refresh everything: bookings and card render
        async function refreshAll() {
            await loadBookings();
            renderCards();
            renderBookingsTable();
        }

        // Listen to filters
        ['areaFilter','filterFrom','filterTo','minCapacity'].forEach(id => document.getElementById(id).addEventListener('input', renderCards));

        // initial load
        (async function(){
            await loadBookings();
            renderCards();
            renderBookingsTable();
        })();

    </script>
</body>
</html>
