<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venue Booking</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        /* Page layout: single-screen, non-scrolling (content fits into viewport) */
        :root{--panel-width:420px}

        .page-wrap{display:flex;gap:20px;height:calc(100vh - var(--nav-height));padding:8px 18px 18px 18px;box-sizing:border-box}

        /* Left: filter + grid */
        .left-col{flex:1;display:flex;flex-direction:column;gap:12px;overflow:hidden}

        /* Sticky filter bar */
        .filter-bar{position:sticky;top:8px;background:rgba(255,255,255,0.98);padding:18px;border-radius:12px;box-shadow:var(--shadow);display:flex;gap:12px;align-items:center;z-index:50}
        .filter-bar .control{min-width:0;flex:1;padding:12px 14px;font-size:15px}

        /* Grid that fills remaining space without causing page scroll */
        .grid-wrap{flex:1;overflow:auto;padding:6px}
        .venue-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:22px}
        .venue-grid h3{grid-column:1/-1;margin:0;padding:8px 6px;color:#0f172a;border-radius:6px}

        .venue-card{background:var(--card-bg);border-radius:12px;padding:18px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:10px;transition:transform var(--transition),box-shadow var(--transition);position:relative}
        .venue-card:hover{transform:translateY(-6px);box-shadow:0 14px 30px rgba(0,0,0,0.12)}


        .venue-title{font-weight:800;font-size:18px;margin:0;padding-right:56px}
        .capacity{position:absolute;right:14px;top:14px;font-size:13px;color:#7b8794}
        .meta-row{font-size:13px;color:#667;display:flex;justify-content:space-between;gap:8px}
        .location{font-size:13px;color:#6b7280}
        .equip{font-size:13px;color:#374151;opacity:0.95;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

        .badge-available{background:var(--success);color:#fff;padding:6px 8px;border-radius:8px;font-weight:700;display:inline-flex;align-items:center;gap:6px}
        .badge-partial{background:var(--warning);color:#111;padding:6px 8px;border-radius:8px;font-weight:700;display:inline-flex;align-items:center;gap:6px}
        .badge-booked{background:var(--danger);color:#fff;padding:6px 8px;border-radius:8px;font-weight:700;display:inline-flex;align-items:center;gap:6px}

        .badge-icon{font-size:14px;line-height:1}

        .venue-card.booked{opacity:0.55}

        .card-actions{display:flex;gap:8px;margin-top:auto;justify-content:flex-end}

        /* Right: booking panel */
        .right-col{width:var(--panel-width);display:flex;flex-direction:column;gap:12px}
        .booking-panel{background:var(--card-bg);padding:16px;border-radius:10px;box-shadow:var(--shadow);transform:translateX(16px);transition:transform var(--transition),opacity var(--transition);opacity:0;pointer-events:none}
        .booking-panel.open{transform:translateX(0);opacity:1;pointer-events:auto}

        .bookings-collapsed{background:var(--card-bg);padding:12px;border-radius:10px;box-shadow:var(--shadow)}
        .toggle-btn{background:transparent;border:1px solid #ddd;padding:8px 12px;border-radius:8px;cursor:pointer}

        .notice{padding:8px 10px;border-radius:8px;background:#fff3cd;color:#856404;font-size:14px}

        /* Mini datepicker popover */
        .mini-cal{position:absolute;background:var(--card-bg);box-shadow:var(--shadow);border-radius:8px;padding:8px;width:260px;z-index:2000}
        .mini-cal .cal-head{display:flex;justify-content:space-between;align-items:center;padding:6px 4px;font-weight:600}
        .mini-cal .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;padding:6px}
        .mini-cal .day{height:34px;display:flex;align-items:center;justify-content:center;border-radius:6px;cursor:pointer}
        .mini-cal .day:hover{background:#f1f5f9}
        .mini-cal .day.disabled{color:#9ca3af;cursor:not-allowed;opacity:0.7}
        .mini-cal .day.booked{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5;cursor:not-allowed}
        .mini-cal .dow{font-size:12px;color:#6b7280;text-align:center}

        /* Ensure small screens degrade gracefully */
        @media (max-width:1200px){.venue-grid{grid-template-columns:repeat(2,1fr)}}
        @media (max-width:720px){.venue-grid{grid-template-columns:repeat(1,1fr)}.page-wrap{flex-direction:column;height:calc(100vh - var(--nav-height));padding:12px}.right-col{width:100%}.booking-panel{position:relative}}

        /* Bookings modal */
        .modal-overlay{position:fixed;inset:0;background:rgba(12,18,30,0.45);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:2000}
        .bookings-modal{background:white;border-radius:12px;max-width:900px;width:92%;max-height:80vh;overflow:auto;padding:18px;box-shadow:0 20px 60px rgba(2,6,23,0.4);position:relative}
        .bookings-modal h3{margin-top:0}
        .bookings-modal table{width:100%;border-collapse:collapse}
        .bookings-modal th{background:#ff7a00;color:#fff;padding:10px;text-align:left;border-bottom:1px solid #eee}
        .bookings-modal td{padding:12px;border-bottom:1px solid #f1f5f9}
        .bookings-modal .toggle-btn{background:#fff;border:1px solid #e6e6e6;padding:6px 8px;border-radius:8px;color:#111}
        .bookings-close{position:absolute;right:12px;top:8px;border:none;background:transparent;font-size:18px;cursor:pointer}
    </style>
</head>
<body>
    <div id="navbar"></div>

<script>
    fetch("/css/components/navbar.html")
        .then(res => res.text())
        .then(html => {
            document.getElementById("navbar").innerHTML = html;
            const logoutBtn = document.getElementById("logoutBtn");
            if (logoutBtn) logoutBtn.addEventListener("click", () => { localStorage.clear(); window.location.href = "/"; });
        });
</script>

    <div class="nav-spacer"></div>

    <div class="page-wrap">
        <div class="left-col">
            <div class="filter-bar" role="region" aria-label="Venue filters">
                <select id="areaFilter" class="control">
                    <option value="">All areas</option>
                    <option value="Main Block">Main Block</option>
                    <option value="PG Block">PG Block</option>
                    <option value="KE Block">KE Block</option>
                    <option value="Outdoor Areas">Outdoor Areas</option>
                </select>

                <input type="date" id="filterFrom" class="control" aria-label="From date">
                <input type="date" id="filterTo" class="control" aria-label="To date">
                <input type="number" id="minCapacity" class="control" placeholder="Min capacity" min="0" aria-label="Minimum capacity">
                <button id="openBookingsBtn" class="toggle-btn" style="margin-left:auto">My Bookings</button>
            </div>
            <div id="filterSummary" style="font-size:13px;color:#374151;margin-top:6px">Showing 0 venues based on selected filters.</div>

            <div class="grid-wrap">
                <div id="venueGrid" class="venue-grid" aria-live="polite"></div>
            </div>
        </div>

        
    </div>

    <!-- booking panel (moved out of right-column so grid can expand) -->
    <div class="booking-panel" id="bookingPanel" aria-hidden="true" style="position:fixed;right:18px;top:80px;z-index:1800;max-width:420px">
        <h3 id="panelTitle">Book Venue</h3>
        <form id="panelForm">
            <label>Area</label>
            <input type="text" id="panelArea" readonly>
            <label>Venue</label>
            <input type="text" id="panelVenue" readonly>
            <label>Event name</label>
            <input type="text" id="panelEvent" required>
            <label>Club name</label>
            <input type="text" id="panelClub" required>
            <label>From</label>
            <input type="date" id="panelFrom" required>
            <label>To</label>
            <input type="date" id="panelTo" required>

            <div id="panelNotice" class="notice" style="display:none"></div>

            <div style="display:flex;gap:8px;margin-top:10px">
                <button type="submit" id="panelSubmit">Book</button>
                <button type="button" id="panelClose" class="toggle-btn">Close</button>
            </div>
        </form>
    </div>

    <script>
        // -- AUTH CHECK (redirect if no role) --
        const role = localStorage.getItem("role");
        if (!role) {
            // silently redirect to login
            window.location.href = "/";
        }

        // -- DATA: venues (derived from original table content) --
        const venuesData = [
            {name:"Sunya Lab", location:"Main Block", equipment:"3D printer, Laser cutter, Vinyl cutter", capacity:20},
            {name:"Multimedia hall", location:"Main Block", equipment:"Projector, Speakers, Mic system", capacity:100},
            {name:"Heisenberg Lab", location:"Main Block", equipment:"Computing equipment, IoT equipment", capacity:77},
            {name:"Quantum Lab", location:"Main Block", equipment:"Computing equipment, Projector", capacity:75},
            {name:"Zuse Lab", location:"Main Block", equipment:"Computing equipment, Networking components", capacity:76},
            {name:"Ulysses Lab", location:"Main Block", equipment:"Computing equipment", capacity:35},
            {name:"CCF Lab", location:"Main Block", equipment:"Computing equipment", capacity:75},
            {name:"Gallery Hall", location:"PG Block", equipment:"Projector, Mic system, Speakers", capacity:300},
            {name:"Project Laboratory", location:"KE Block", equipment:"Welding machine, Hacksaw, Grinding machine", capacity:50},
            {name:"Language Lab", location:"KE Block", equipment:"Computing equipment, Headphones", capacity:75},
            {name:"Sycamore lab Phase 1", location:"KE Block", equipment:"Computing equipment", capacity:75},
            {name:"Sycamore lab Phase 2", location:"KE Block", equipment:"Computing equipment", capacity:75},
            {name:"CU Seminar Hall", location:"KE Block", equipment:"Projector", capacity:72},
            {name:"Conference Hall", location:"KE Block", equipment:"Projector, Mic system, Speakers", capacity:250},
            {name:"Auditorium", location:"KE Block", equipment:"Projector, Mic and speaker system, Displays, Lighting system", capacity:2500},
            {name:"Badminton Court", location:"KE Block", equipment:"Floodlight", capacity:0},
            {name:"Table tennis Court", location:"KE Block", equipment:"Floodlight", capacity:0},
            {name:"Basketball Court", location:"Outdoor Areas", equipment:"Floodlight, Open ground", capacity:300},
            {name:"Volleyball Court", location:"Outdoor Areas", equipment:"Floodlight, Open ground", capacity:0},
            {name:"Football Ground", location:"Outdoor Areas", equipment:"Open ground", capacity:0},
            {name:"Cricket Ground", location:"Outdoor Areas", equipment:"Floodlight, Open ground, Pavilion", capacity:0},
            {name:"Cricket Nets", location:"Outdoor Areas", equipment:"Nets", capacity:0},
            {name:"Parking Gound", location:"Outdoor Areas", equipment:"Open ground", capacity:0},
            {name:"Chavara Hall", location:"Outdoor Areas", equipment:"Lighting system, Mic and speaker system, Displays", capacity:600},
            {name:"STEAG", location:"Outdoor Areas", equipment:"Open space", capacity:0},
            {name:"The Bamboos", location:"Outdoor Areas", equipment:"Open space", capacity:20}
        ];

        // Store bookings loaded from server
        let currentBookings = [];
        let bookedDatesByVenue = {}; // map venue -> Set(dates)

        // Fetch bookings and build quick lookup
        async function loadBookings() {
            const res = await fetch('/venue-bookings');
            currentBookings = await res.json();

            bookedDatesByVenue = {};
            currentBookings.forEach(b => {
                if (!bookedDatesByVenue[b.venue]) bookedDatesByVenue[b.venue] = new Set();
                let from = new Date(b.from_date);
                const to = new Date(b.to_date);
                for (let d = new Date(from); d <= to; d.setDate(d.getDate()+1)) {
                    bookedDatesByVenue[b.venue].add(new Date(d).toISOString().split('T')[0]);
                }
            });
        }

        // Compute availability status for a venue given optional filter range
        function computeAvailability(venueName, filterFrom, filterTo) {
            const booked = bookedDatesByVenue[venueName] || new Set();
            if (!filterFrom || !filterTo) {
                // No filter -> if any booked dates exist -> partially/booked else available
                if (booked.size === 0) return 'Available';
                return 'Partially Booked';
            }
            // Check if all days in range are booked
            let from = new Date(filterFrom);
            let to = new Date(filterTo);
            let totalDays = 0, bookedDays = 0;
            for (let d = new Date(from); d <= to; d.setDate(d.getDate()+1)) {
                totalDays++;
                if (booked.has(d.toISOString().split('T')[0])) bookedDays++;
            }
            if (bookedDays === 0) return 'Available';
            if (bookedDays === totalDays) return 'Booked';
            return 'Partially Booked';
        }

        // Render cards according to filters
        function renderCards() {
            const area = document.getElementById('areaFilter').value;
            const from = document.getElementById('filterFrom').value;
            const to = document.getElementById('filterTo').value;
            const minCap = parseInt(document.getElementById('minCapacity').value || '0', 10);
            const container = document.getElementById('venueGrid');
            container.innerHTML = '';

            const filtered = venuesData
                .filter(v => {
                    if (area && v.location !== area) return false;
                    if (v.capacity < minCap) return false;
                    return true;
                })
                .slice() // copy
                .sort((a,b)=> a.location.localeCompare(b.location) || a.name.localeCompare(b.name));

            // group by location and render section headers
            let lastArea = null;
            let shown = 0;
            filtered.forEach(v => {
                const avail = computeAvailability(v.name, from, to);
                // create header when area changes
                if (v.location !== lastArea) {
                    const h = document.createElement('h3');
                    h.textContent = v.location;
                    h.style.margin = '10px 0 6px';
                    h.style.fontSize = '16px';
                    h.style.color = '#111827';
                    container.appendChild(h);
                    lastArea = v.location;
                }

                const card = document.createElement('div');
                card.className = 'venue-card' + (avail==='Booked' ? ' booked' : '');

                // show only first 1-2 equipment items to reduce noise
                const equipItems = (v.equipment||'').split(',').map(s=>s.trim()).filter(Boolean);
                const shortEquip = equipItems.slice(0,2).join(', ')+ (equipItems.length>2? '…': '');

                const badgeClass = avail==='Available' ? 'badge-available' : avail==='Partially Booked' ? 'badge-partial' : 'badge-booked';
                const badgeIcon = avail==='Available' ? '✓' : avail==='Partially Booked' ? '⚠' : '✖';

                card.innerHTML = `
                    <div class="capacity">${v.capacity>0? v.capacity+' seats':'—'}</div>
                    <div class="venue-title">${v.name}</div>
                    <div class="location">${v.location}</div>
                    <div class="equip" title="${escapeHtml(v.equipment)}">${escapeHtml(shortEquip)}</div>
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div class="badge ${badgeClass}"><span class="badge-icon">${badgeIcon}</span><span class="badge-text">${avail}</span></div>
                        <div class="card-actions">
                            <button class="btn" ${avail==='Booked' ? 'disabled' : ''} data-book="${encodeURIComponent(v.name)}">Book</button>
                        </div>
                    </div>
                `;

                // actions
                const bookBtn = card.querySelector('[data-book]');
                bookBtn?.addEventListener('click', () => openBookingPanel(v, from, to));

                container.appendChild(card);
                shown++;
            });

            // update filter summary
            document.getElementById('filterSummary').textContent = `Showing ${filtered.length} venues based on selected filters.`;
        }

        function showDetails(v) {
            // simple inline details modal replacement — use accessibility-friendly dialog in future
            const msg = `${v.name} — ${v.location}\nEquipment: ${v.equipment}\nCapacity: ${v.capacity>0? v.capacity:'N/A'}`;
            // Use non-blocking notification
            showPanelMessage(msg, 3500);
        }

        // Booking panel controls
        const bookingPanel = document.getElementById('bookingPanel');
        const panelForm = document.getElementById('panelForm');
        const panelNotice = document.getElementById('panelNotice');

        function openBookingPanel(venueObj, filterFrom, filterTo) {
            document.getElementById('panelArea').value = venueObj.location;
            document.getElementById('panelVenue').value = venueObj.name;
            document.getElementById('panelEvent').value = '';
            document.getElementById('panelClub').value = '';
            document.getElementById('panelFrom').value = filterFrom || '';
            document.getElementById('panelTo').value = filterTo || '';
            panelNotice.style.display = 'none';
            bookingPanel.classList.add('open');
            bookingPanel.setAttribute('aria-hidden','false');
        }

        document.getElementById('panelClose').addEventListener('click', () => {
            bookingPanel.classList.remove('open');
            bookingPanel.setAttribute('aria-hidden','true');
        });

        // Open bookings modal (replaces inline toggle)
        document.getElementById('openBookingsBtn').addEventListener('click', async () => {
            await loadBookings();
            showBookingsModal();
        });

        function showBookingsModal(){
            // prevent duplicate
            if (document.querySelector('.modal-overlay')) return;
            const overlay = document.createElement('div'); overlay.className = 'modal-overlay';
            const modal = document.createElement('div'); modal.className = 'bookings-modal';

            const closeBtn = document.createElement('button'); closeBtn.className = 'bookings-close'; closeBtn.innerHTML = '✕';
            closeBtn.addEventListener('click', closeBookingsModal);
            modal.appendChild(closeBtn);

            const title = document.createElement('h3'); title.textContent = 'My Bookings'; modal.appendChild(title);

            const table = document.createElement('table');
            table.innerHTML = '<tr><th>Event</th><th>Club</th><th>From</th><th>To</th><th>Venue</th><th>Status</th><th>Actions</th></tr>';
            currentBookings.forEach(b => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${escapeHtml(b.event_name)}</td><td>${escapeHtml(b.club_name)}</td><td>${b.from_date}</td><td>${b.to_date}</td><td>${escapeHtml(b.venue)}</td><td>${escapeHtml(b.status)}</td><td><button class="toggle-btn" onclick="editBooking(${b.id}, '${escapeJs(b.event_name)}', '${escapeJs(b.club_name)}', '${escapeJs(b.venue)}', '${b.from_date}', '${b.to_date}')">Edit</button> <button class="toggle-btn" onclick="deleteBooking(${b.id})">Delete</button></td>`;
                table.appendChild(tr);
            });

            modal.appendChild(table);

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // close on overlay click outside modal
            overlay.addEventListener('click', (e)=>{ if (e.target === overlay) closeBookingsModal(); });
            // escape key
            document.addEventListener('keydown', escHandler);
            function escHandler(e){ if (e.key === 'Escape') closeBookingsModal(); }

            // store handler so it can be removed
            overlay._escHandler = escHandler;
        }

        function closeBookingsModal(){
            const overlay = document.querySelector('.modal-overlay');
            if (!overlay) return;
            const escHandler = overlay._escHandler;
            if (escHandler) document.removeEventListener('keydown', escHandler);
            overlay.remove();
        }

        // Inline non-blocking message area (top-right small toast)
        function showPanelMessage(text, timeout=2000) {
            panelNotice.textContent = text; panelNotice.style.display = 'block';
            if (timeout) setTimeout(()=> panelNotice.style.display='none', timeout);
        }

        // Submit booking from panel (uses same endpoints as before)
        panelForm.addEventListener('submit', async function(e){
            e.preventDefault();
            const eventName = document.getElementById('panelEvent').value.trim();
            const clubName = document.getElementById('panelClub').value.trim();
            const fromDate = document.getElementById('panelFrom').value;
            const toDate = document.getElementById('panelTo').value;
            const venue = document.getElementById('panelVenue').value;

            if (!venue) return showPanelMessage('Select a venue.');

            // client-side availability check (non-alert)
            await loadBookings(); // refresh bookings
            const overlapping = currentBookings.some(b => b.venue === venue && (
                (fromDate >= b.from_date && fromDate <= b.to_date) ||
                (toDate >= b.from_date && toDate <= b.to_date) ||
                (fromDate <= b.from_date && toDate >= b.to_date)
            ));

            if (overlapping) {
                panelNotice.style.display = 'block';
                panelNotice.textContent = 'Selected range overlaps existing booking. Pick different dates.';
                return;
            }

            // send booking
            await fetch('/book-venue', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ event_name: eventName, club_name: clubName, from_date: fromDate, to_date: toDate, venue })
            });

            showPanelMessage('Booked successfully!', 2000);
            bookingPanel.classList.remove('open');
            await refreshAll();
        });

        // Delete booking (replaces confirm() with inline show)
        async function deleteBooking(id) {
            if (!confirm) { // still use native confirm for destructive action — keep minimal
                // fallback
            }
            // Simple UI confirm via window.confirm (kept minimal); could be replaced with modal
            if (!window.confirm('Delete booking?')) return;
            await fetch(`/delete-booking/${id}`, {method:'DELETE'});
            await refreshAll();
        }

        // Populate bookings table
        async function renderBookingsTable() {
            const table = document.getElementById('venueTable');
            if (!table) return; // nothing to do if table location isn't present (we use modal table instead)
            table.innerHTML = '<tr><th>Event</th><th>Club</th><th>From</th><th>To</th><th>Venue</th><th>Status</th><th>Actions</th></tr>';
            currentBookings.forEach(b => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${escapeHtml(b.event_name)}</td><td>${escapeHtml(b.club_name)}</td><td>${b.from_date}</td><td>${b.to_date}</td><td>${escapeHtml(b.venue)}</td><td>${escapeHtml(b.status)}</td><td><button class="toggle-btn" onclick="editBooking(${b.id}, '${escapeJs(b.event_name)}', '${escapeJs(b.club_name)}', '${escapeJs(b.venue)}', '${b.from_date}', '${b.to_date}')">Edit</button> <button class="toggle-btn" onclick="deleteBooking(${b.id})">Delete</button></td>`;
                table.appendChild(tr);
            });
        }

        // provide global editBooking (used by table buttons)
        window.editBooking = function(id, eventName, clubName, venue, fromDate, toDate) {
            document.getElementById('panelArea').value = ''; // unknown
            document.getElementById('panelVenue').value = venue;
            document.getElementById('panelEvent').value = eventName;
            document.getElementById('panelClub').value = clubName;
            document.getElementById('panelFrom').value = fromDate;
            document.getElementById('panelTo').value = toDate;
            bookingPanel.classList.add('open');
            // change submission to update instead of create
            panelForm.onsubmit = async function(e){
                e.preventDefault();
                await fetch(`/edit-booking/${id}`, {method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({ event_name: document.getElementById('panelEvent').value, club_name: document.getElementById('panelClub').value, from_date: document.getElementById('panelFrom').value, to_date: document.getElementById('panelTo').value, venue: document.getElementById('panelVenue').value })});
                showPanelMessage('Booking updated',1500); bookingPanel.classList.remove('open'); await refreshAll();
                panelForm.onsubmit = defaultPanelSubmit;
            };
        };

        // helpers
        function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
        function escapeJs(s){ return (s||'').replace(/'/g,"\\'").replace(/"/g,'\"'); }

        // default panel submit (re-usable)
        async function defaultPanelSubmit(e) { e.preventDefault(); }
        window.defaultPanelSubmit = defaultPanelSubmit;

        // Refresh everything: bookings and card render
        async function refreshAll() {
            await loadBookings();
            renderCards();
            renderBookingsTable();
        }

        // Listen to filters
        ['areaFilter','filterFrom','filterTo','minCapacity'].forEach(id => document.getElementById(id).addEventListener('input', renderCards));

        // initial load
        (async function(){
            await loadBookings();
            renderCards();
            renderBookingsTable();
        })();

        /* ===== Mini datepicker bound to panelFrom / panelTo ===== */
        (function(){
            let activeCal = null;

            function formatYMD(date){
                const y = date.getFullYear();
                const m = String(date.getMonth()+1).padStart(2,'0');
                const d = String(date.getDate()).padStart(2,'0');
                return `${y}-${m}-${d}`;
            }

            function buildCalendar(year, month, venueName){
                const cal = document.createElement('div');
                cal.className = 'mini-cal';

                const head = document.createElement('div'); head.className='cal-head';
                const prev = document.createElement('button'); prev.textContent='◀'; prev.style.border='none'; prev.style.background='transparent'; prev.style.cursor='pointer';
                const next = document.createElement('button'); next.textContent='▶'; next.style.border='none'; next.style.background='transparent'; next.style.cursor='pointer';
                const title = document.createElement('div'); title.textContent = new Date(year,month,1).toLocaleString(undefined,{month:'long',year:'numeric'});
                head.appendChild(prev); head.appendChild(title); head.appendChild(next);

                const grid = document.createElement('div'); grid.className='cal-grid';

                // day of week headers
                ['Su','Mo','Tu','We','Th','Fr','Sa'].forEach(dow=>{ const el=document.createElement('div'); el.className='dow'; el.textContent=dow; grid.appendChild(el); });

                const first = new Date(year,month,1);
                const start = new Date(first); start.setDate(first.getDate() - first.getDay());

                for(let i=0;i<42;i++){
                    const cur = new Date(start); cur.setDate(start.getDate()+i);
                    const day = document.createElement('div'); day.className='day'; day.textContent = cur.getDate();
                    const iso = formatYMD(cur);

                    // mark days not in this month muted
                    if (cur.getMonth() !== month) { day.style.opacity = '0.35'; }

                    // mark booked if present for this venue
                    const bookedSet = bookedDatesByVenue[venueName] || new Set();
                    if (bookedSet.has(iso)) { day.classList.add('booked','disabled'); day.title = 'Booked'; }

                    // attach click handler for selectable days
                    day.addEventListener('click', (e)=>{
                        if (day.classList.contains('disabled')) return;
                        const input = cal.__boundInput;
                        if (input) { input.value = iso; input.dispatchEvent(new Event('input',{bubbles:true})); hideCal(cal); }
                    });

                    grid.appendChild(day);
                }

                cal.appendChild(head); cal.appendChild(grid);

                // navigation
                prev.addEventListener('click', ()=>{ const d=new Date(year,month-1,1); const newCal = buildCalendar(d.getFullYear(), d.getMonth(), venueName); replaceCal(cal, newCal); });
                next.addEventListener('click', ()=>{ const d=new Date(year,month+1,1); const newCal = buildCalendar(d.getFullYear(), d.getMonth(), venueName); replaceCal(cal, newCal); });

                return cal;
            }

            function replaceCal(oldCal, newCal){
                if (!oldCal || !oldCal.parentNode) return;
                // preserve bound input
                newCal.__boundInput = oldCal.__boundInput;
                oldCal.parentNode.replaceChild(newCal, oldCal);
                activeCal = newCal;
            }

            function hideCal(cal){ if (!cal) return; cal.remove(); activeCal = null; }

            function showCalendarFor(input){
                // ensure bookings loaded
                const venue = document.getElementById('panelVenue').value || '';
                const today = input.value ? new Date(input.value) : new Date();
                const cal = buildCalendar(today.getFullYear(), today.getMonth(), venue);
                cal.__boundInput = input;

                // position
                const rect = input.getBoundingClientRect();
                cal.style.position = 'absolute';
                cal.style.left = (rect.left + window.scrollX) + 'px';
                cal.style.top = (rect.bottom + window.scrollY + 6) + 'px';

                document.body.appendChild(cal);
                activeCal = cal;
            }

            // attach to panel inputs
            const fromInput = document.getElementById('panelFrom');
            const toInput = document.getElementById('panelTo');

            fromInput.addEventListener('focus', (e)=>{ showCalendarFor(fromInput); });
            toInput.addEventListener('focus', (e)=>{ showCalendarFor(toInput); });

            // hide on outside click
            document.addEventListener('click', (e)=>{
                if (!activeCal) return;
                if (e.target.closest('.mini-cal')) return;
                if (e.target === fromInput || e.target === toInput) return;
                hideCal(activeCal);
            });

            // re-render when bookings change
            const origLoadBookings = loadBookings;
            loadBookings = async function(){ await origLoadBookings(); if (activeCal) { const bound = activeCal.__boundInput; hideCal(activeCal); showCalendarFor(bound); } };
        })();

    </script>
</body>
</html>
