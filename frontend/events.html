<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        /* Base and animation */
        body{animation:fadeIn .45s ease-in-out;margin:0;font-family:Inter, Arial, sans-serif;background:#f4f6f9;color:var(--text)}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}

        /* Page layout */
        .page-center{max-width:1200px;margin:28px auto;padding:0 16px;box-sizing:border-box}

        /* Form card */
        #eventFormContainer{max-width:600px;margin:8px auto 28px;background:var(--card-bg);padding:28px;border-radius:12px;box-shadow:var(--shadow);text-align:left}
        #eventFormContainer h3{font-size:22px;margin:0 0 14px;font-weight:700}

        /* Form groups and layout */
        .form-row{display:flex;gap:12px}
        .form-row .col{flex:1}
        .form-group{margin-bottom:12px}

        input, select, textarea{width:100%;padding:12px;border:1px solid #e6e9ef;border-radius:10px;font-size:15px;box-sizing:border-box}
        input:focus, select:focus, textarea:focus{outline:3px solid rgba(37,99,235,0.08);border-color:#2563eb}
        textarea{min-height:110px;resize:vertical}

        /* Primary action */
        .primary-btn{width:100%;padding:12px;border-radius:10px;background:var(--primary);color:white;font-weight:700;border:none;cursor:pointer;transition:transform .12s ease,box-shadow .12s}
        .primary-btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(37,99,235,0.12)}

        /* Table section separation */
        .section-divider{height:1px;background:linear-gradient(90deg,transparent,#e9eef8,transparent);margin:24px 0}
        .events-table-wrap{background:transparent;padding-top:18px}

        /* Make table rows appear as spaced cards */
        table{width:100%;border-collapse:separate;border-spacing:0 12px;background:transparent}
        thead tr th{background:transparent}
        tbody tr{background:transparent}
        th,td{padding:14px 18px;border-bottom:0;font-size:14px;vertical-align:middle}
        th{color:#0f172a;text-transform:uppercase;font-size:13px}
        td{background:var(--card-bg);box-shadow:0 6px 18px rgba(15,23,42,0.04);border-radius:8px}
        td:first-child{border-top-left-radius:8px;border-bottom-left-radius:8px}
        td:last-child{border-top-right-radius:8px;border-bottom-right-radius:8px}
        tr.event-row td{padding:18px 20px}
        .actions-cell button{display:block;margin:6px 0;padding:10px 14px;border-radius:10px}

        /* Table styling lighter than form */
        table{width:100%;border-collapse:collapse;background:transparent;box-shadow:none;border-radius:8px}
        th,td{padding:10px 12px;border-bottom:1px solid #eef2f8;font-size:14px}
        th{background:transparent;color:#0f172a;text-transform:uppercase;font-size:13px;text-align:left}
        tr:nth-child(even){background:transparent}

        /* Responsive adjustments */
        @media(min-width:760px){.form-row.split{display:flex}.form-row.split .col{flex:1}}
        @media(max-width:759px){.form-row{flex-direction:column}}
    </style>
</head>
<body>
    <div id="navbar"></div>

<script>
    
    fetch("/css/components/navbar.html")
        .then(res => res.text())
        .then(html => {
            document.getElementById("navbar").innerHTML = html;
            const logoutBtn = document.getElementById("logoutBtn");
            if (logoutBtn) logoutBtn.addEventListener("click", () => { localStorage.clear(); window.location.href = "/"; });
        });
</script>

    

    <div class="section-divider"></div>
    <div class="page-center">
        <h2 style="margin-top:0">Events</h2>
        <div style="display:flex;gap:18px;margin-top:18px;align-items:flex-start">
            <div id="eventsList" style="flex:1 1 75%;max-height:78vh;overflow:auto;background:var(--card-bg);padding:18px;border-radius:12px;box-shadow:var(--shadow)">
                <div class="events-table-wrap">
                    <table id="eventTable">
                        <tr>
                            <th>Name</th>
                            <th>Date & Time</th>
                            <th>Venue</th>
                            <th>Organized By</th>
                            <th>Description</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th id="actionsHeader" style="display: none;">Actions</th>
                        </tr>
                    </table>
                </div>
            </div>

            <div id="eventFormColumn" style="flex:0 0 24%">
                <div id="eventFormContainer" style="display:none;">
                    <h3>Add / Edit Event</h3>
                    <form id="eventForm">
                        <input type="hidden" id="eventId">

                        <div class="form-group">
                            <label class="sr-only" for="name">Event name</label>
                            <input type="text" id="name" placeholder="Event Name" required>
                        </div>

                        <div class="form-row split">
                            <div class="col form-group">
                                <label class="sr-only" for="date">Date</label>
                                <input type="date" id="date" required>
                            </div>
                            <div class="col form-group">
                                <label class="sr-only" for="time">Time</label>
                                <input type="time" id="time" required>
                            </div>
                        </div>

                        <div class="form-row split">
                            <div class="col form-group">
                                <label class="sr-only" for="venue">Venue</label>
                                <input type="text" id="venue" placeholder="Venue" required>
                            </div>
                            <div class="col form-group">
                                <label class="sr-only" for="organizer">Organizer</label>
                                <input type="text" id="organizer" placeholder="Organized By" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="sr-only" for="desc">Description</label>
                            <textarea id="desc" placeholder="Description" required></textarea>
                        </div>

                        <div class="form-row">
                            <div class="col form-group">
                                <label class="sr-only" for="eventType">Event Type</label>
                                <select id="eventType" required>
                                    <option value="Games">Games</option>
                                    <option value="Sports">Sports</option>
                                    <option value="Arts">Arts</option>
                                    <option value="Workshop">Workshop</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <button class="primary-btn" type="submit">Save Event</button>
                        </div>
                    </form>
                </div>
                <div id="filterContainer" style="display:none;margin-top:8px;">
                    <label for="eventFilter">Filter by Event Type:</label>
                    <select id="eventFilter" onchange="filterEvents()">
                        <option value="all">All</option>
                        <option value="Games">Games</option>
                        <option value="Sports">Sports</option>
                        <option value="Arts">Arts</option>
                        <option value="Workshop">Workshop</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    <script>
        const role = localStorage.getItem("role");
if (!role) {
  alert("Please log in to access UniSync.");
  window.location.href = "/";
}
        
        let canManage = role === "Clubleader";
        let isStudent = role === "student";
    
        document.getElementById("eventFormContainer").style.display = canManage ? "block" : "none";
        document.getElementById("actionsHeader").style.display = canManage ? "table-cell" : "none";
        document.getElementById("filterContainer").style.display = isStudent ? "block" : "none";
    
        async function loadEvents() {
            try {
                let response = await fetch("/api/events");
                if (!response.ok) {
                    const text = await response.text();
                    console.error("Failed to load events:", response.status, text);
                    return;
                }
                let events = await response.json();
                displayEvents(events || []);
            } catch (err) {
                console.error("Error loading events:", err);
            }
        }
    
        function displayEvents(events) {
    let table = document.getElementById("eventTable");
    table.innerHTML = `<tr>
        <th>Name</th>
        <th>Date & Time</th>
        <th>Venue</th>
        <th>Organized By</th>
        <th>Description</th>
        <th>Type</th>
        <th>Status</th>
        ${canManage ? "<th>Actions</th>" : ""}
    </tr>`;

    let now = new Date(); // Get the current time

    events.forEach(event => {
        let eventDateTime = new Date(`${event.date}T${event.time}`);
        let status = "";

        if (eventDateTime > now) {
            status = "Upcoming";
        } else if (now >= eventDateTime && now <= new Date(event.date + "T23:59")) {
            status = "Ongoing";
        } else {
            status = "Completed";
        }

        table.innerHTML += `
            <tr class="event-row" data-type="${event.type}">
                <td>${event.name}</td>
                <td>${event.date} ${event.time}</td>
                <td>${event.venue}</td>
                <td>${event.organizer}</td>
                <td>${event.desc}</td>
                <td>${event.type}</td>
                <td>${status}</td> <!-- ✅ Correctly Display Calculated Status -->
                ${canManage ? `<td>
                    <button onclick="editEvent(${event.id}, '${event.name}', '${event.date}', '${event.time}', '${event.venue}', '${event.organizer}', '${event.desc}', '${event.type}')">Edit</button>
                    <button onclick="deleteEvent(${event.id})">Delete</button>
                </td>` : ""}
            </tr>`;
    });
}

async function deleteEvent(id) {
    if (confirm("Are you sure you want to delete this event?")) {
        let response = await fetch(`/api/delete-event/${id}`, {
            method: "DELETE"
        });

        if (response.ok) {
            alert("Event deleted successfully!");
            loadEvents(); // ✅ Refresh the event list after deletion
        } else {
            alert("Failed to delete event.");
        }
    }
}

        function filterEvents() {
            let selectedType = document.getElementById("eventFilter").value;
            let rows = document.querySelectorAll(".event-row");
    
            rows.forEach(row => {
                row.style.display = (selectedType === "all" || row.dataset.type === selectedType) ? "" : "none";
            });
        }
    
        function editEvent(id, name, date, time, venue, organizer, desc, type) {
            document.getElementById("eventId").value = id;
            document.getElementById("name").value = name;
            document.getElementById("date").value = date;
            document.getElementById("time").value = time;
            document.getElementById("venue").value = venue;
            document.getElementById("organizer").value = organizer;
            document.getElementById("desc").value = desc;
            document.getElementById("eventType").value = type;
        }
    
        document.getElementById("eventForm").addEventListener("submit", async function(event) {
            event.preventDefault();

            let id = document.getElementById("eventId").value;
            let payload = {
                name: document.getElementById("name").value,
                date: document.getElementById("date").value,
                time: document.getElementById("time").value,
                venue: document.getElementById("venue").value,
                organizer: document.getElementById("organizer").value,
                desc: document.getElementById("desc").value,
                type: document.getElementById("eventType").value
            };

            try {
                const resp = await fetch(id ? `/api/edit-event/${id}` : "/api/add-event", {
                    method: id ? "PUT" : "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) {
                    const text = await resp.text();
                    console.error("Failed to save event:", resp.status, text);
                    alert("Failed to save event: " + (text || resp.status));
                    return;
                }

                const data = await resp.json().catch(() => ({}));
                console.log(id ? "Event updated!" : "Event added successfully", data);

                document.getElementById("eventForm").reset();
                loadEvents();
            } catch (err) {
                console.error("Network or JS error saving event:", err);
                alert("Failed to save event (network). See console for details.");
            }
        });
    
        loadEvents();
    </script>
